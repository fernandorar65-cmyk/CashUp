// CashUp - Schema Prisma para PostgreSQL
// Plataforma de microcr√©ditos con credit scoring

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  documentId    String   @unique @map("document_id")
  monthlyIncome Decimal  @map("monthly_income") @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  creditProfile CreditProfile?
  loans         Loan[]

  @@map("users")
}

model CreditProfile {
  id                String   @id @default(cuid())
  userId            String   @unique @map("user_id")
  creditScore       Int      @default(50) @map("credit_score") // 0-100
  totalDebt         Decimal  @default(0) @map("total_debt") @db.Decimal(12, 2)
  onTimePayments    Int      @default(0) @map("on_time_payments")
  latePayments      Int      @default(0) @map("late_payments")
  lastScoreUpdate   DateTime? @map("last_score_update")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_profiles")
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PAID
  DEFAULTED
}

model Loan {
  id              String     @id @default(cuid())
  userId          String     @map("user_id")
  amount          Decimal    @db.Decimal(12, 2)
  termMonths      Int        @map("term_months")
  interestRate    Decimal    @map("interest_rate") @db.Decimal(5, 4)
  monthlyPayment  Decimal    @map("monthly_payment") @db.Decimal(12, 2)
  totalToPay      Decimal    @map("total_to_pay") @db.Decimal(12, 2)
  status          LoanStatus @default(PENDING)
  creditScoreAt   Int?       @map("credit_score_at")
  rejectionReason String?    @map("rejection_reason")
  approvedAt      DateTime?  @map("approved_at")
  disbursedAt     DateTime?  @map("disbursed_at")
  dueDate         DateTime?  @map("due_date")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedule     AmortizationItem[]
  payments     Payment[]

  @@map("loans")
}

model AmortizationItem {
  id            String   @id @default(cuid())
  loanId        String   @map("loan_id")
  installmentNumber Int  @map("installment_number")
  dueDate       DateTime @map("due_date")
  principal     Decimal  @db.Decimal(12, 2)
  interest      Decimal  @db.Decimal(12, 2)
  latePenalty   Decimal  @default(0) @map("late_penalty") @db.Decimal(12, 2)
  totalDue      Decimal  @map("total_due") @db.Decimal(12, 2)
  paidAmount    Decimal  @default(0) @map("paid_amount") @db.Decimal(12, 2)
  paidAt        DateTime? @map("paid_at")
  isOverdue     Boolean  @default(false) @map("is_overdue")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  loan    Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("amortization_items")
}

model Payment {
  id          String   @id @default(cuid())
  loanId      String   @map("loan_id")
  itemId      String?  @map("item_id")
  amount      Decimal  @db.Decimal(12, 2)
  appliedToPrincipal Decimal @default(0) @map("applied_to_principal") @db.Decimal(12, 2)
  appliedToInterest  Decimal @default(0) @map("applied_to_interest") @db.Decimal(12, 2)
  appliedToPenalty   Decimal @default(0) @map("applied_to_penalty") @db.Decimal(12, 2)
  isLate      Boolean  @default(false) @map("is_late")
  paidAt      DateTime @default(now()) @map("paid_at")
  createdAt   DateTime @default(now()) @map("created_at")

  loan Loan             @relation(fields: [loanId], references: [id], onDelete: Cascade)
  item AmortizationItem? @relation(fields: [itemId], references: [id])

  @@map("payments")
}
